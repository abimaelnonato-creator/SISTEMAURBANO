version: '3.8'

services:
  # ===== EVOLUTION API =====
  evolution-api:
    image: atendai/evolution-api:v2.1.1
    container_name: evolution_api
    restart: always
    ports:
      - "8080:8080"
    environment:
      # ===== CONFIGURAÇÃO BÁSICA =====
      - SERVER_URL=https://evolution.gestao.parnamirim.rn.gov.br
      - SERVER_PORT=8080
      - SERVER_DISABLE_MANAGER=false
      - SERVER_DISABLE_DOCS=false
      
      # ===== CORS =====
      - CORS_ORIGIN=*
      - CORS_METHODS=GET,POST,PUT,DELETE
      - CORS_CREDENTIALS=true
      
      # ===== LOGS =====
      - LOG_LEVEL=ERROR,WARN,DEBUG,INFO,LOG,VERBOSE,DARK,WEBHOOKS
      - LOG_COLOR=true
      - LOG_BAILEYS=error
      
      # ===== ARMAZENAMENTO DE INSTÂNCIAS =====
      - DEL_INSTANCE=false
      - DEL_TEMP_INSTANCES=true
      - STORE_MESSAGES=true
      - STORE_MESSAGE_UP=true
      - STORE_CONTACTS=true
      - STORE_CHATS=true
      
      # ===== LIMPEZA AUTOMÁTICA =====
      - CLEAN_STORE_CLEANING_INTERVAL=7200
      - CLEAN_STORE_MESSAGES=true
      - CLEAN_STORE_MESSAGE_UP=true
      - CLEAN_STORE_CONTACTS=true
      - CLEAN_STORE_CHATS=true
      
      # ===== BANCO DE DADOS =====
      - DATABASE_ENABLED=true
      - DATABASE_PROVIDER=postgresql
      - DATABASE_CONNECTION_URI=postgresql://evolution:evolution_pass@postgres:5432/evolution
      - DATABASE_CONNECTION_CLIENT_NAME=evolution_api
      - DATABASE_SAVE_DATA_INSTANCE=true
      - DATABASE_SAVE_DATA_NEW_MESSAGE=true
      - DATABASE_SAVE_MESSAGE_UPDATE=true
      - DATABASE_SAVE_DATA_CONTACTS=true
      - DATABASE_SAVE_DATA_CHATS=true
      - DATABASE_SAVE_DATA_LABELS=true
      - DATABASE_SAVE_DATA_HISTORIC=true
      
      # ===== REDIS =====
      - CACHE_REDIS_ENABLED=true
      - CACHE_REDIS_URI=redis://redis:6379/1
      - CACHE_REDIS_PREFIX_KEY=evolution
      - CACHE_REDIS_SAVE_INSTANCES=true
      - CACHE_LOCAL_ENABLED=false
      
      # ===== RABBITMQ (OPCIONAL) =====
      - RABBITMQ_ENABLED=false
      
      # ===== WEBSOCKET =====
      - WEBSOCKET_ENABLED=true
      - WEBSOCKET_GLOBAL_EVENTS=false
      
      # ===== WEBHOOK GLOBAL =====
      - WEBHOOK_GLOBAL_ENABLED=true
      - WEBHOOK_GLOBAL_URL=http://api:3000/api/whatsapp/webhook
      - WEBHOOK_GLOBAL_WEBHOOK_BY_EVENTS=true
      - WEBHOOK_EVENTS_APPLICATION_STARTUP=true
      - WEBHOOK_EVENTS_QRCODE_UPDATED=true
      - WEBHOOK_EVENTS_MESSAGES_SET=true
      - WEBHOOK_EVENTS_MESSAGES_UPSERT=true
      - WEBHOOK_EVENTS_MESSAGES_EDITED=true
      - WEBHOOK_EVENTS_MESSAGES_UPDATE=true
      - WEBHOOK_EVENTS_MESSAGES_DELETE=true
      - WEBHOOK_EVENTS_SEND_MESSAGE=true
      - WEBHOOK_EVENTS_CONTACTS_SET=true
      - WEBHOOK_EVENTS_CONTACTS_UPSERT=true
      - WEBHOOK_EVENTS_CONTACTS_UPDATE=true
      - WEBHOOK_EVENTS_PRESENCE_UPDATE=true
      - WEBHOOK_EVENTS_CHATS_SET=true
      - WEBHOOK_EVENTS_CHATS_UPSERT=true
      - WEBHOOK_EVENTS_CHATS_UPDATE=true
      - WEBHOOK_EVENTS_CHATS_DELETE=true
      - WEBHOOK_EVENTS_GROUPS_UPSERT=true
      - WEBHOOK_EVENTS_GROUPS_UPDATE=true
      - WEBHOOK_EVENTS_GROUP_PARTICIPANTS_UPDATE=true
      - WEBHOOK_EVENTS_CONNECTION_UPDATE=true
      - WEBHOOK_EVENTS_LABELS_EDIT=true
      - WEBHOOK_EVENTS_LABELS_ASSOCIATION=true
      - WEBHOOK_EVENTS_CALL=true
      - WEBHOOK_EVENTS_TYPEBOT_START=false
      - WEBHOOK_EVENTS_TYPEBOT_CHANGE_STATUS=false
      - WEBHOOK_EVENTS_ERRORS=true
      - WEBHOOK_EVENTS_ERRORS_WEBHOOK=true
      
      # ===== CONFIGURAÇÃO DE QR CODE =====
      - QRCODE_LIMIT=30
      - QRCODE_COLOR=#0a1628
      
      # ===== AUTENTICAÇÃO =====
      - AUTHENTICATION_TYPE=apikey
      # ⚠️ TROCAR ESTA CHAVE EM PRODUÇÃO!
      - AUTHENTICATION_API_KEY=PARNAMIRIM_EVOLUTION_API_KEY_2024_MUDAR_EM_PRODUCAO
      - AUTHENTICATION_EXPOSE_IN_FETCH_INSTANCES=true
      
      # ===== CONFIGURAÇÃO DE INSTÂNCIA =====
      - CONFIG_SESSION_PHONE_CLIENT=Ouvidoria Parnamirim
      - CONFIG_SESSION_PHONE_NAME=Chrome
      - CONFIG_SESSION_PHONE_VERSION=2.2413.51
      
      # ===== S3/MINIO PARA MÍDIA =====
      - S3_ENABLED=true
      - S3_ACCESS_KEY=minioadmin
      - S3_SECRET_KEY=minioadmin
      - S3_BUCKET=evolution
      - S3_PORT=9000
      - S3_ENDPOINT=minio
      - S3_USE_SSL=false
      
    volumes:
      - evolution_instances:/evolution/instances
    networks:
      - parnamirim_network
    depends_on:
      - postgres
      - redis
      - minio

  # ===== POSTGRESQL WITH POSTGIS =====
  postgres:
    image: postgis/postgis:15-3.3
    container_name: postgres
    restart: always
    environment:
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=admin_secure_password_2024
      - POSTGRES_MULTIPLE_DATABASES=parnamirim_gestao,evolution
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/postgres/init-multiple-dbs.sh:/docker-entrypoint-initdb.d/init-multiple-dbs.sh
    ports:
      - "5432:5432"
    networks:
      - parnamirim_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===== REDIS =====
  redis:
    image: redis:7-alpine
    container_name: redis
    restart: always
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    networks:
      - parnamirim_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===== MINIO (S3) =====
  minio:
    image: minio/minio:latest
    container_name: minio
    restart: always
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    volumes:
      - minio_data:/data
    ports:
      - "9000:9000"
      - "9001:9001"
    networks:
      - parnamirim_network

  # ===== API PRINCIPAL (NestJS) =====
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: api
    restart: always
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://admin:admin_secure_password_2024@postgres:5432/parnamirim_gestao
      - REDIS_URL=redis://redis:6379/0
      - EVOLUTION_API_URL=http://evolution-api:8080
      - EVOLUTION_API_KEY=PARNAMIRIM_EVOLUTION_API_KEY_2024_MUDAR_EM_PRODUCAO
      - EVOLUTION_INSTANCE_NAME=ouvidoria_parnamirim
    depends_on:
      - postgres
      - redis
      - evolution-api
    networks:
      - parnamirim_network

  # ===== pgAdmin (opcional - para gerenciamento do banco) =====
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@parnamirim.rn.gov.br
      PGADMIN_DEFAULT_PASSWORD: admin123
    ports:
      - "5050:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      - postgres
    networks:
      - parnamirim_network

  # ===== Redis Commander (opcional - para visualização do Redis) =====
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: redis-commander
    restart: unless-stopped
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
    ports:
      - "8081:8081"
    depends_on:
      - redis
    networks:
      - parnamirim_network

volumes:
  postgres_data:
  redis_data:
  minio_data:
  evolution_instances:
  pgadmin_data:

networks:
  parnamirim_network:
    driver: bridge
