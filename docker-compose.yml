# docker-compose.yml
# Sistema de Gestão Urbana - Parnamirim/RN
# MVP para teste completo do fluxo WhatsApp -> IA -> Dashboard

services:
  # ===== EVOLUTION API (WHATSAPP) =====
  # PostgreSQL e Redis já estão rodando nos containers sistmurbano-postgres e parnamirim_redis
  evolution-api:
    image: atendai/evolution-api:v2.1.1
    container_name: parnamirim_evolution
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      # Server Config
      - SERVER_URL=http://localhost:8080
      
      # Authentication
      - AUTHENTICATION_TYPE=apikey
      - AUTHENTICATION_API_KEY=PARNAMIRIM_KEY_2024
      - AUTHENTICATION_EXPOSE_IN_FETCH_INSTANCES=true
      
      # QR Code
      - QRCODE_LIMIT=30
      
      # Webhook Global - Aponta para o backend NestJS
      - WEBHOOK_GLOBAL_ENABLED=true
      - WEBHOOK_GLOBAL_URL=http://host.docker.internal:3000/api/v1/whatsapp/webhook
      - WEBHOOK_GLOBAL_WEBHOOK_BY_EVENTS=true
      
      # Eventos de Webhook
      - WEBHOOK_EVENTS_MESSAGES_UPSERT=true
      - WEBHOOK_EVENTS_MESSAGES_UPDATE=true
      - WEBHOOK_EVENTS_CONNECTION_UPDATE=true
      - WEBHOOK_EVENTS_QRCODE_UPDATED=true
      
      # Database - usando provider postgresql
      - DATABASE_ENABLED=false
      - DATABASE_PROVIDER=postgresql
      - DATABASE_CONNECTION_URI=postgresql://postgres:postgres@host.docker.internal:5432/evolution?schema=public
      
      # Redis Cache - usando Redis existente
      - CACHE_REDIS_ENABLED=true
      - CACHE_REDIS_URI=redis://host.docker.internal:6379/1
      - CACHE_REDIS_PREFIX_KEY=evolution
      
      # Session Config
      - CONFIG_SESSION_PHONE_CLIENT=Ouvidoria Parnamirim
      
      # Logs
      - LOG_LEVEL=ERROR,WARN,INFO
    extra_hosts:
      - "host.docker.internal:host-gateway"
    network_mode: bridge
